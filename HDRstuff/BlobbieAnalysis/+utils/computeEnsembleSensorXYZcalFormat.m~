function [ensembleSensorXYZcalFormat, nCols, mRows] = computeEnsembleSensorXYZcalFormat(calStructOBJ, shapeConds, alphaConds, specularSPDconds, lightingConds, lightingCondIndex)

    ensembleSensorXYZcalFormat = [];
    
    Tsensor = calStructOBJ.get('T_sensor');
    Ssensor = calStructOBJ.get('S');
    
    dataIsRemote = false;
    if (dataIsRemote)
        % remote
        dataPath = '/Volumes/ColorShare1/Users/Shared/Matlab/Analysis/SamsungProject/RawData/MultispectralData_0deg';
    else
        % local
        topFolder = fileparts(which(mfilename));
        dataPath = fullfile(topFolder,'MultispectralData_0deg');
    end
    
    
    for specularSPDindex = 1:numel(specularSPDconds)
        for shapeIndex = 1:numel(shapeConds)
            for alphaIndex = 1:numel(alphaConds)
                
                % Retrieve image
                 % Assemble image file name
                imageName = sprintf('Blobbie9Subs%sFreq_Samsung_FlatSpecularReflectance_%s.spd___Samsung_NeutralDay_BlueGreen_0.60.spd___alpha_%s___Lights_%s_rotationAngle_0.mat', ...
        shapeConds{shapeIndex}, specularSPDconds{specularSPDindex}, alphaConds{alphaIndex},  lightingConds{lightingCondIndex});
    
                [multiSpectralImage, multiSpectralImageS] = RetrieveMultiSpectralImage(shapeIndex, alphaIndex, specularSPDindex, lightingCondIndex);
    
                % compute sensorXYZ image
                sensorXYZimage = MultispectralToSensorImage(multiSpectralImage, multiSpectralImageS, Tsensor, Ssensor);
                
                % To cal format
                [sensorXYZcalFormat, nCols, mRows] = ImageToCalFormat(sensorXYZimage);
    
                if isempty(ensembleSensorXYZcalFormat)
                    ensembleSensorXYZcalFormat = zeros(numel(shapeConds), numel(alphaConds), numel(specularSPDconds), size(sensorXYZcalFormat,1), size(sensorXYZcalFormat,2));
                end
                
                ensembleSensorXYZcalFormat(shapeIndex, alphaIndex, specularSPDindex,:,:) = sensorXYZcalFormat;
            end
        end
    end
end

function [multiSpectralImage, multiSpectralImageS]  = RetrieveMultiSpectralImage(shapeIndex, alphaIndex, specularSPDindex, lightingCondIndex)
    
    dataIsRemote = false;
    if (dataIsRemote)
        % remote
        dataPath = '/Volumes/ColorShare1/Users/Shared/Matlab/Analysis/SamsungProject/RawData/MultispectralData_0deg';
    else
        % local
        topFolder = fileparts(which(mfilename));
        dataPath = fullfile(topFolder,'MultispectralData_0deg');
    end

    [multiSpectralImage, multiSpectralImageS] = utils.loadMultispectralImage(dataPath, shapeIndex, alphaIndex, specularSPDindex, lightingCondIndex);

end

% Load the multispectral image data
function [multiSpectralImage, S] = loadMultispectralImage(dataPath, shapeIndex, alphaIndex, specularSPDindex, lightingCondIndex)
    global shapeConds
    global alphaConds
    global specularSPDconds
    global lightingConds
    
    
    % Load the image
    fprintf('Fetching image from ''%s'' Please wait ...\n', dataPath);
    HDRdata = load(fullfile(dataPath,imageName));
    
    % extract image data
    multiSpectralImage = HDRdata.multispectralImage * HDRdata.radiometricScaleFactor;
    % return S vector
    S = HDRdata.S;
end